# Искра IDE API - Документация

**Base URL:** `https://cli.cryptocatslab.ru`

## Аутентификация

### 1. Регистрация (отправка кода)
```http
POST /auth/register
Content-Type: application/json

{
  "email": "user@example.com",
  "password": "your_password",
  "deviceId": "unique-device-id"
}
```

**Ответ:**
```json
{
  "message": "Verification code sent to email",
  "email": "user@example.com"
}
```

На указанный email придет 6-значный код подтверждения (действителен 10 минут).

---

### 2. Подтверждение кода
```http
POST /auth/verify
Content-Type: application/json

{
  "email": "user@example.com",
  "code": "123456"
}
```

**Ответ:**
```json
{
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "user": {
    "id": 1,
    "email": "user@example.com",
    "tier": "free"
  }
}
```

Сохраните `token` - он нужен для всех последующих запросов.

---

### 3. Вход
```http
POST /auth/login
Content-Type: application/json

{
  "email": "user@example.com",
  "password": "your_password"
}
```

**Ответ:**
```json
{
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "user": {
    "id": 1,
    "email": "user@example.com",
    "tier": "free"
  }
}
```

---

### 4. Повторная отправка кода
```http
POST /auth/resend-code
Content-Type: application/json

{
  "email": "user@example.com"
}
```

**Ответ:**
```json
{
  "message": "Code resent"
}
```

---

## AI Запросы

Все AI endpoints требуют JWT токен в заголовке:
```
Authorization: Bearer YOUR_JWT_TOKEN
```

### 5. Qwen - обычный запрос
```http
POST /ai/qwen/complete
Authorization: Bearer YOUR_JWT_TOKEN
Content-Type: application/json

{
  "model": "qwen3-coder-flash",
  "messages": [
    {
      "role": "user",
      "content": "Напиши функцию сортировки массива на Python"
    }
  ],
  "temperature": 0.7,
  "max_tokens": 2000
}
```

**Доступные модели Qwen:**
- `qwen3-coder-plus` - мощная модель
- `qwen3-coder-flash` - быстрая модель (рекомендуется для free tier)

**Ответ:**
```json
{
  "id": "chatcmpl-123",
  "model": "qwen3-coder-flash",
  "choices": [
    {
      "message": {
        "role": "assistant",
        "content": "def sort_array(arr):\n    return sorted(arr)"
      },
      "finish_reason": "stop"
    }
  ],
  "usage": {
    "prompt_tokens": 15,
    "completion_tokens": 20,
    "total_tokens": 35
  }
}
```

---

### 6. Claude - обычный запрос
```http
POST /ai/claude/complete
Authorization: Bearer YOUR_JWT_TOKEN
Content-Type: application/json

{
  "model": "claude-haiku-4-5",
  "messages": [
    {
      "role": "user",
      "content": "Объясни что такое рекурсия"
    }
  ],
  "temperature": 0.7,
  "max_tokens": 2000
}
```

**Доступные модели Claude:**
- `claude-haiku-4-5` - быстрая модель (рекомендуется для free tier)
- `claude-sonnet-4-5` - сбалансированная модель
- `claude-3-7-sonnet-20250219` - продвинутая модель

**Ответ:** аналогичен Qwen

---

### 7. Qwen - стриминг
```http
POST /ai/qwen/stream
Authorization: Bearer YOUR_JWT_TOKEN
Content-Type: application/json

{
  "model": "qwen3-coder-flash",
  "messages": [
    {
      "role": "user",
      "content": "Напиши длинную статью про AI"
    }
  ],
  "stream": true
}
```

**Ответ:** Server-Sent Events (SSE)
```
data: {"choices":[{"delta":{"content":"AI"}}]}

data: {"choices":[{"delta":{"content":" это"}}]}

data: {"choices":[{"delta":{"content":" технология"}}]}

data: [DONE]
```

---

### 8. Claude - стриминг
```http
POST /ai/claude/stream
Authorization: Bearer YOUR_JWT_TOKEN
Content-Type: application/json

{
  "model": "claude-haiku-4-5",
  "messages": [
    {
      "role": "user",
      "content": "Расскажи про квантовые компьютеры"
    }
  ],
  "stream": true
}
```

**Ответ:** Server-Sent Events (SSE) - аналогично Qwen

---

### 9. Function Calling (Qwen)
```http
POST /ai/qwen/complete
Authorization: Bearer YOUR_JWT_TOKEN
Content-Type: application/json

{
  "model": "qwen3-coder-plus",
  "messages": [
    {
      "role": "user",
      "content": "Какая погода в Москве?"
    }
  ],
  "tools": [
    {
      "type": "function",
      "function": {
        "name": "get_weather",
        "description": "Получить погоду в городе",
        "parameters": {
          "type": "object",
          "properties": {
            "city": {
              "type": "string",
              "description": "Название города"
            }
          },
          "required": ["city"]
        }
      }
    }
  ]
}
```

**Ответ с вызовом функции:**
```json
{
  "choices": [
    {
      "message": {
        "role": "assistant",
        "tool_calls": [
          {
            "id": "call_123",
            "type": "function",
            "function": {
              "name": "get_weather",
              "arguments": "{\"city\":\"Москва\"}"
            }
          }
        ]
      }
    }
  ]
}
```

---

### 10. Список моделей
```http
GET /ai/models/qwen
Authorization: Bearer YOUR_JWT_TOKEN
```

**Ответ:**
```json
{
  "models": [
    "qwen3-coder-plus",
    "qwen3-coder-flash"
  ]
}
```

```http
GET /ai/models/claude
Authorization: Bearer YOUR_JWT_TOKEN
```

**Ответ:**
```json
{
  "models": [
    "claude-haiku-4-5",
    "claude-sonnet-4-5",
    "claude-3-7-sonnet-20250219"
  ]
}
```

---

## Биллинг (ЮKassa)

### 11. Создание платежа
```http
POST /billing/create
Authorization: Bearer YOUR_JWT_TOKEN
Content-Type: application/json

{
  "tier": "pro",
  "returnUrl": "https://yourapp.com/payment-success"
}
```

**Доступные тарифы:**
- `pro` - 990₽/месяц, 500 запросов/день
- `pro_plus` - 1990₽/месяц, 2000 запросов/день

**Ответ:**
```json
{
  "paymentId": "2d8f5678-1234-5678-abcd-1234567890ab",
  "confirmationUrl": "https://yoomoney.ru/checkout/payments/v2/contract?orderId=...",
  "amount": 990
}
```

Перенаправьте пользователя на `confirmationUrl` для оплаты.

---

### 12. Проверка статуса платежа
```http
GET /billing/status/:paymentId
Authorization: Bearer YOUR_JWT_TOKEN
```

**Ответ:**
```json
{
  "status": "succeeded",
  "paid": true,
  "amount": "990.00"
}
```

**Возможные статусы:**
- `pending` - ожидает оплаты
- `succeeded` - оплачен
- `canceled` - отменен

---

### 13. Webhook (для ЮKassa)
```http
POST /billing/webhook
Content-Type: application/json

{
  "type": "notification",
  "event": "payment.succeeded",
  "object": {
    "id": "payment-id",
    "status": "succeeded",
    "paid": true,
    "metadata": {
      "user_id": "123",
      "tier": "pro"
    }
  }
}
```

Этот endpoint вызывается автоматически ЮKassa при изменении статуса платежа.

---

## Лимиты и тарифы

### Free (бесплатно)
- 20 запросов в день
- Доступ к Qwen Flash и Claude Haiku
- Email верификация обязательна

### Pro (990₽/месяц)
- 500 запросов в день
- Доступ ко всем моделям
- Приоритетная поддержка

### Pro+ (1990₽/месяц)
- 2000 запросов в день
- Доступ ко всем моделям
- Максимальный приоритет

---

## Коды ошибок

- `400` - Неверный запрос (проверьте параметры)
- `401` - Не авторизован (токен отсутствует или невалиден)
- `403` - Доступ запрещен (email не подтвержден или лимит исчерпан)
- `429` - Превышен лимит запросов
- `500` - Внутренняя ошибка сервера

---

## Примеры использования

### JavaScript (fetch)
```javascript
const response = await fetch('https://cli.cryptocatslab.ru/ai/qwen/complete', {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${token}`,
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    model: 'qwen3-coder-flash',
    messages: [
      { role: 'user', content: 'Hello!' }
    ]
  })
});

const data = await response.json();
console.log(data.choices[0].message.content);
```

### Python (requests)
```python
import requests

response = requests.post(
    'https://cli.cryptocatslab.ru/ai/claude/complete',
    headers={
        'Authorization': f'Bearer {token}',
        'Content-Type': 'application/json'
    },
    json={
        'model': 'claude-haiku-4-5',
        'messages': [
            {'role': 'user', 'content': 'Привет!'}
        ]
    }
)

data = response.json()
print(data['choices'][0]['message']['content'])
```

### cURL
```bash
curl -X POST https://cli.cryptocatslab.ru/ai/qwen/complete \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "model": "qwen3-coder-flash",
    "messages": [{"role": "user", "content": "Test"}]
  }'
```

---

## Поддержка

Email: iskra@cryptocatslab.ru
